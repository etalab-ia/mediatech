name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        pip install -e .
    
    - name: Validate installation
      run: |
        mediatech --help  # Check if the command is available
        python -c "import config; import database; import download_and_processing; print('All imports are OK')"

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - name: Check lockfile on VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          PROJECT_DIR="${{ secrets.VM_PROJECT_DIR }}"

          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found: Please check the VM_PROJECT_DIR secret."
            exit 1
          fi
          
          cd "$PROJECT_DIR"

          if [ -f tmp/update.lock ]; then
            echo "Deployment is locked. Please wait for the current collections update to finish."
            exit 1
          else
            echo "No collections update in progress, deploying..."
          fi

    - name: Code sync
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e 

          PROJECT_DIR="${{ secrets.VM_PROJECT_DIR }}"
        
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found: Please check the VM_PROJECT_DIR secret."
            exit 1
          fi
          
          cd "$PROJECT_DIR"
          
          git pull origin main
          
          if [ ! -f .env ]; then
            echo "There is no .env file. Please create it from .env.example."
            exit 1
          fi
          
          source .venv/bin/activate 2>/dev/null || python3 -m venv .venv && source .venv/bin/activate
          pip install -e .

    - name: System setup
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e 

          PROJECT_DIR="${{ secrets.VM_PROJECT_DIR }}"
        
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found: Please check the VM_PROJECT_DIR secret."
            exit 1
          fi
          
          cd "$PROJECT_DIR"

          if [ -f scripts/deployment_packages.sh ]; then
            ./scripts/deployment_packages.sh
          else
            echo "Deployment script not found."
            exit 1
          fi
    
    - name: Container deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e 

          PROJECT_DIR="${{ secrets.VM_PROJECT_DIR }}"
        
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found: Please check the VM_PROJECT_DIR secret."
            exit 1
          fi
          
          cd "$PROJECT_DIR"
          
          if [ -f docker-compose.yml ]; then
            sudo docker compose down || true
            sudo docker compose pull
            sudo docker compose up -d
          else
            echo "docker-compose.yml not found."
            exit 1
          fi